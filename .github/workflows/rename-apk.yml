name: Rename Release APK

on:
  release:
    types: [published]

jobs:
  rename-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set version
        run: |
          TAG_NAME=${{ github.event.release.tag_name }}
          VERSION=${TAG_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Using version: $VERSION"

      - name: Download APK
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download ${{ github.event.release.tag_name }} --pattern '*.apk'

      - name: Rename APK
        run: |
          APK_FILE=$(ls *.apk | head -n 1)
          NEW_NAME="update_$VERSION.apk"
          mv "$APK_FILE" "$NEW_NAME"
          echo "Renamed $APK_FILE -> $NEW_NAME"

      - name: Replace Release APK
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 删除旧 APK
          gh release view ${{ github.event.release.tag_name }} --json assets --jq '.assets[].name' | tr -d '"' | while read asset; do
            if [[ $asset == *.apk ]]; then
              ASSET_ID=$(gh release view ${{ github.event.release.tag_name }} --json assets --jq ".assets[] | select(.name==\"$asset\") | .id")
              gh release delete-asset $ASSET_ID --yes
            fi
          done

          # 上传新 APK
          gh release upload ${{ github.event.release.tag_name }} "update_$VERSION.apk"
