name: Rename Release APK

on:
  release:
    types: [published]

jobs:
  rename-apk:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout 仓库
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2️⃣ 获取版本号并去掉 v 前缀
      - name: Set version
        run: |
          TAG_NAME=${{ github.event.release.tag_name }}
          VERSION=${TAG_NAME#v}  # 去掉开头的 v
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Using version: $VERSION"

      # 3️⃣ 下载 APK Asset（假设 Release 里只有一个 APK）
      - name: Download APK
        run: |
          gh release download ${{ github.event.release.tag_name }} --pattern '*.apk'

      # 4️⃣ 重命名 APK
      - name: Rename APK
        run: |
          APK_FILE=$(ls *.apk | head -n 1)
          NEW_NAME="update_$VERSION.apk"
          mv "$APK_FILE" "$NEW_NAME"
          echo "Renamed $APK_FILE -> $NEW_NAME"

      # 5️⃣ 替换 Release APK
      - name: Replace Release APK
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ASSETS=$(gh release view ${{ github.event.release.tag_name }} --json assets --jq '.assets[].name')
          for asset in $ASSETS; do
            if [[ $asset == *.apk ]]; then
              ASSET_ID=$(gh release view ${{ github.event.release.tag_name }} --json assets --jq ".assets[] | select(.name==\"$asset\") | .id")
              gh release delete-asset $ASSET_ID --yes
            fi
          done
          gh release upload ${{ github.event.release.tag_name }} "update_$VERSION.apk"
