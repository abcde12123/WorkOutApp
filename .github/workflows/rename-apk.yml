name: Rename Release APK

on:
  release:
    types: [published]

jobs:
  rename-apk:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout 仓库
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 避免 detached HEAD

      # 2️⃣ 安装 GitHub CLI
      - name: Install GitHub CLI
        run: |
          sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-key C99B11DEB97541F0
          sudo apt-add-repository https://cli.github.com/packages
          sudo apt update
          sudo apt install gh -y

      # 3️⃣ 登录 GitHub CLI
      - name: Authenticate GH CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh auth setup-git

      # 4️⃣ 获取版本号并去掉 v 前缀
      - name: Set version
        run: |
          TAG_NAME=${{ github.event.release.tag_name }}
          VERSION=${TAG_NAME#v}  # 去掉开头的 v
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Using version: $VERSION"

      # 5️⃣ 下载 APK Asset（假设 Release 里只有一个 APK）
      - name: Download APK
        run: |
          gh release download ${{ github.event.release.tag_name }} --pattern '*.apk'

      # 6️⃣ 重命名 APK
      - name: Rename APK
        run: |
          APK_FILE=$(ls *.apk | head -n 1)  # 找到 APK
          NEW_NAME="update_$VERSION.apk"
          mv "$APK_FILE" "$NEW_NAME"
          echo "Renamed $APK_FILE -> $NEW_NAME"

      # 7️⃣ 删除旧 Asset 并上传新 APK
      - name: Replace Release APK
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ASSETS=$(gh release view ${{ github.event.release.tag_name }} --json assets --jq '.assets[].name')
          for asset in $ASSETS; do
            if [[ $asset == *.apk ]]; then
              ASSET_ID=$(gh release view ${{ github.event.release.tag_name }} --json assets --jq ".assets[] | select(.name==\"$asset\") | .id")
              gh release delete-asset $ASSET_ID --yes
            fi
          done
          gh release upload ${{ github.event.release.tag_name }} "update_$VERSION.apk"
